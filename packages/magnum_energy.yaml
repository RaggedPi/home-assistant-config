################################################################
## Ragged Jack Farm                                           ##
## Package: Magnum Energy                                     ##
## Author: David Durost <david.durost@gmail.com>              ##
## Url: http://ragedjackfarm.net                              ##
################################################################
homeassistant:
  customize:
      package.node_anchors:
        customize: &customize
          package: 'magnum'
      sensor.magnum_inverter_mode:
        friendly_name: Inverter Mode
      sensor.magnum_inverter_AACin:
        friendly_name: Input AC Amps
      sensor.magnum_inverter_AACout:
        friendly_name: Output AC Amps
      sensor.magnum_inverter_adc:
        friendly_name: Inverter DC Amps
      sensor.magnum_inverter_bat:
        friendly_name: Battery Temperature
      sensor.magnum_inverter_fault:
        friendly_name: Fault
      sensor.magnum_inverter_fet:
        friendly_name: FET Temperature
      sensor.magnum_inverter_model:
        friendly_name: Inverter Model
      sensor.magnum_inverter_revision:
        friendly_name: Inverter Revision
      sensor.magnum_inverter_tfmr:
        friendly_name: Transformer Temperature
      sensor.magnum_inverter_VACin:
        friendly_name: Input AC Voltage
      sensor.magnum_inverter_VACout:
        friendly_name: Output AC Voltage
      sensor.magnum_inverter_vdc:
        friendly_name: Inverter DC Voltage
      sensor.magnum_inverter_frequency:
        friendly_name: Frequency
      sensor.magnum_bmk_adc:
        friendly_name: BMK DC Amperage
      sensor.magnum_bmk_amph:
        friendly_name: Amphours
      sensor.magnum_bmk_fault:
        friendly_name: BMK Fault Code
      sensor.magnum_bmk_fault_text:
        friendly_name: BMK Fault
      sensor.magnum_bmk_soc:
        friendly_name: State of Charge
      sensor.magnum_bmk_vdc:
        friendly_name: BMK DC Voltage
      sensor.magnum_bmk_vmax:
        friendly_name: Max Voltage
      sensor.magnum_bmk_vmin:
        friendly_name: Min Voltage
      sensor.magnum_ags_revision:
        friendly_name: AGS Revision
      sensor.magnum_ags_running:
        friendly_name: AGS Gen Running
      sensor.magnum_ags_status:
        friendly_name: AGS Status Code
      sensor.magnum_ags_status_text:
        friendly_name: AGS Status
      sensor.magnum_ags_vdc:
        friendly_name: AGS DC Voltage
  customize_glob:
    "sensor.magnum_*":
      icon: mdi:power-socket-us

# LWT Messages
mqtt:
  birth_message:
    topic: 'magnum/status'
    payload: 'online'
  will_message:
    topic: 'magnum/status'
    payload: 'offline'

sensor:
  # Inverter ###################################################
  # Revision
  - platform: mqtt
    name: magnum_inverter_revision
    state_topic: "magnum/inverter"
    value_template: "{{ value_json.data.revision }}"
    json_attributes_topic: "magnum/inverter"
    json_attributes_template: "{{ value_json.data.revision | tojson }}" 
  # Mode
  - platform: mqtt
    name: magnum_inverter_mode
    state_topic: "magnum/inverter"
    value_template: "{{ value_json.data.mode }}"      
    json_attributes_topic: "magnum/inverter"
    json_attributes_template: "{{ value_json.data.mode | tojson }}" 
  # Fault
  - platform: mqtt
    name: magnum_inverter_fault
    state_topic: "magnum/inverter"
    value_template: "{{ value_json.data.fault }}"
    json_attributes_topic: "magnum/inverter"
    json_attributes_template: "{{ value_json.data.fault | tojson }}" 
  # DC Voltage
  - platform: mqtt
    name: magnum_inverter_vdc
    state_topic: "magnum/inverter"
    value_template: "{{ value_json.data.vdc }}"
    json_attributes_topic: "magnum/inverter"
    json_attributes_template: "{{ value_json.data.vdc | tojson }}"
    unit_of_measurement: V
  # DC Amps
  - platform: mqtt
    name: magnum_inverter_adc
    state_topic: "magnum/inverter"
    value_template: "{{ value_json.data.adc }}"
    json_attributes_topic: "magnum/inverter"
    json_attributes_template: "{{ value_json.data.adc | tojson }}" 
    unit_of_measurement: A
  # AC Output Voltage
  - platform: mqtt
    name: magnum_inverter_VACout
    state_topic: "magnum/inverter"
    value_template: "{{ value_json.data.VACout }}"
    json_attributes_topic: "magnum/inverter"
    json_attributes_template: "{{ value_json.data.VACout | tojson }}"
    unit_of_measurement: V
  # AC Input Voltage
  - platform: mqtt
    name: magnum_inverter_VACin
    state_topic: "magnum/inverter"
    value_template: "{{ value_json.data.VACin }}"
    json_attributes_topic: "magnum/inverter"
    json_attributes_template: "{{ value_json.data.VACin | tojson }}"
    unit_of_measurement: V
  # AC Input Amps
  - platform: mqtt
    name: magnum_inverter_AACin
    state_topic: "magnum/inverter"
    value_template: "{{ value_json.data.AACin }}"
    json_attributes_topic: "magnum/inverter"
    json_attributes_template: "{{ value_json.data.AACin | tojson }}" 
    unit_of_measurement: A
  # AC Output Amps
  - platform: mqtt
    name: magnum_inverter_AACout
    state_topic: "magnum/inverter"
    value_template: "{{ value_json.data.AACout }}"
    json_attributes_topic: "magnum/inverter"
    json_attributes_template: "{{ value_json.data.AACout | tojson }}" 
    unit_of_measurement: A
  # Battery Temperature
  - platform: mqtt
    name: magnum_inverter_bat
    state_topic: "magnum/inverter"
    value_template: "{{ value_json.data.bat }}"
    json_attributes_topic: "magnum/inverter"
    json_attributes_template: "{{ value_json.data.bat | tojson }}" 
    unit_of_measurement: C
  # Transformer Temperature
  - platform: mqtt
    name: magnum_inverter_tfmr
    state_topic: "magnum/inverter"
    value_template: "{{ value_json.data.tfmr }}"
    json_attributes_topic: "magnum/inverter"
    json_attributes_template: "{{ value_json.data.tfmr | tojson }}" 
    unit_of_measurement: C
  # FET Temperature
  - platform: mqtt
    name: magnum_inverter_fet
    state_topic: "magnum/inverter"
    value_template: "{{ value_json.data.fet }}"
    json_attributes_topic: "magnum/inverter"
    json_attributes_template: "{{ value_json.data.fet | tojson }}" 
    unit_of_measurement: C
  # Model
  - platform: mqtt
    name: magnum_inverter_model
    state_topic: "magnum/inverter"
    value_template: "{{ value_json.data.model_text }}"
    json_attributes_topic: "magnum/inverter"
    json_attributes_template: "{{ value_json.data.model_text | tojson }}" 
  # Frequency
  - platform: mqtt
    name: magnum_inverter_frequency
    state_topic: "magnum/inverter"
    value_template: "{{ value_json.data.Hz }}"
    json_attributes_topic: "magnum/inverter"
    json_attributes_template: "{{ value_json.data.Hz | tojson }}" 
    unit_of_measurement: Hz

  # Bmk ########################################################
  # Revision
  - platform: mqtt
    name: magnum_bmk_revision
    state_topic: "magnum/bmk"
    value_template: "{{ value_json.data.revision }}"
    json_attributes_topic: "magnum/bmk"
    json_attributes_template: "{{ value_json.data.revision | tojson }}"
  # SOC
  - platform: mqtt
    name: magnum_bmk_soc
    state_topic: "magnum/bmk"
    value_template: "{{ value_json.data.soc }}"
    json_attributes_topic: "magnum/bmk"
    json_attributes_template: "{{ value_json.data.soc | tojson }}" 
    unit_of_measurement: '%'
  # DC Voltage
  - platform: mqtt
    name: magnum_bmk_vdc
    state_topic: "magnum/bmk"
    value_template: "{{ value_json.data.vdc }}"
    json_attributes_topic: "magnum/bmk"
    json_attributes_template: "{{ value_json.data.vdc | tojson }}" 
    unit_of_measurement: V
  # DC Amps
  - platform: mqtt
    name: magnum_bmk_adc
    state_topic: "magnum/bmk"
    value_template: "{{ value_json.data.adc }}"
    json_attributes_topic: "magnum/bmk"
    json_attributes_template: "{{ value_json.data.adc | tojson }}" 
    unit_of_measurement: V
  # Min Voltage
  - platform: mqtt
    name: magnum_bmk_vmin
    state_topic: "magnum/bmk"
    value_template: "{{ value_json.data.vmin }}"
    json_attributes_topic: "magnum/bmk"
    json_attributes_template: "{{ value_json.data.vmin | tojson }}" 
    unit_of_measurement: V
  # Max Voltage
  - platform: mqtt
    name: magnum_bmk_vmax
    state_topic: "magnum/bmk"
    value_template: "{{ value_json.data.vmax }}"
    json_attributes_topic: "magnum/bmk"
    json_attributes_template: "{{ value_json.data.vmax | tojson }}" 
    unit_of_measurement: V
  # Amphours
  - platform: mqtt
    name: magnum_bmk_amph
    state_topic: "magnum/bmk"
    value_template: "{{ value_json.data.amph }}"
    json_attributes_topic: "magnum/bmk"
    json_attributes_template: "{{ value_json.data.amph | tojson }}" 
    unit_of_measurement: Ah
  # Fault Text
  - platform: mqtt
    name: magnum_bmk_fault_text
    state_topic: "magnum/bmk"
    value_template: "{{ value_json.data.Fault_Text }}"
    json_attributes_topic: "magnum/bmk"
    json_attributes_template: "{{ value_json.data.Fault_Text | tojson }}"
  # Fault
  - platform: mqtt
    name: magnum_bmk_fault
    state_topic: "magnum/bmk"
    value_template: "{{ value_json.data.Fault }}"
    json_attributes_topic: "magnum/bmk"
    json_attributes_template: "{{ value_json.data.Fault | tojson }}"

  # AGS ########################################################
  # Revision
  - platform: mqtt
    name: magnum_ags_revision
    state_topic: "magnum/ags"
    value_template: "{{ value_json.data.revision }}"
    json_attributes_topic: "magnum/ags"
    json_attributes_template: "{{ value_json.data.revision | tojson }}"
  # Status
  - platform: mqtt
    name: magnum_ags_status
    state_topic: "magnum/ags"
    value_template: "{{ value_json.data.status }}"
    json_attributes_topic: "magnum/ags"
    json_attributes_template: "{{ value_json.data.status | tojson }}"
  # Status Text
  - platform: mqtt
    name: magnum_ags_status_text
    state_topic: "magnum/ags"
    value_template: "{{ value_json.data.status_text }}"
    json_attributes_topic: "magnum/ags"
    json_attributes_template: "{{ value_json.data.status_text | tojson }}"
  # Temperature
  - platform: mqtt
    name: magnum_ags_temp
    state_topic: "magnum/ags"
    value_template: "{{ value_json.data.temp }}"
    json_attributes_topic: "magnum/ags"
    json_attributes_template: "{{ value_json.data.temp | tojson }}"
    unit_of_measurement: C
  # Runtime
  - platform: mqtt
    name: magnum_ags_runtime
    state_topic: "magnum/ags"
    value_template: "{{ value_json.data.runtime }}"
    json_attributes_topic: "magnum/ags"
    json_attributes_template: "{{ value_json.data.runtime | tojson }}"
    unit_of_measurement: hours
  # Last SOC
  - platform: mqtt
    name: magnum_ags_last_soc
    state_topic: "magnum/ags"
    value_template: "{{ value_json.data.last_full_soc }}"
    json_attributes_topic: "magnum/ags"
    json_attributes_template: "{{ value_json.data.last_full_soc | tojson }}"
    unit_of_measurement: days
  # Gen Run Total
  - platform: mqtt
    name: magnum_ags_gen_run_total
    state_topic: "magnum/ags"
    value_template: "{{ value_json.data.gen_total_run | float(1) }}"
    json_attributes_topic: "magnum/ags"
    json_attributes_template: "{{ value_json.data.gen_total_run | tojson }}"
    unit_of_measurement: Hrs
  # VDC
  - platform: mqtt
    name: magnum_ags_vdc
    state_topic: "magnum/ags"
    value_template: "{{ value_json.data.vdc }}"
    json_attributes_topic: "magnum/ags"
    json_attributes_template: "{{ value_json.data.vdc | tojson }}"
    unit_of_measurement: V        
  
  # Remote #####################################################
  # Revision
  - platform: mqtt
    name: magnum_remote_revision
    state_topic: "magnum/remote"
    value_template: "{{ value_json.data.revision }}"
    json_attributes_topic: "magnum/remote"
    json_attributes_template: "{{ value_json.data.revision | tojson }}"
  
################################################################
# Template Sensors                                             #
################################################################
  - platform: template
    sensors:
      # Inverter Mode Text
      magnum_inverter_mode_text:
        friendly_name: Mode
        value_template: >-
          {% set mode = states('sensor.magnum_inverter_mode')|int %}
          {% set mapper = {
            '0': 'Charger In Standby',
            '1': 'Equalizing',
            '2': 'Float',
            '4': 'Absorb',
            '8': 'Bulk',
            '9': 'Battery Save',
            '16': 'Charging',
            '32': 'Off',
            '64': 'Inverting',
            '80': 'Inverter In Standby',
            '128': 'Searching' } %}
          {{ mapper[mode] if mode in mapper else "Unknown Code: {}".format(mode) }}

      # Fault Status Text
      magnum_fault:
        friendly_name: System Fault
        value_template: >-
          {% set a_fault = states('sensor.magnum_ags_status')|int %}
          {% set b_fault = states('sensor.magnum_bmk_fault')|int %}
          {% set i_fault = states('sensor.magnum_inverter_fault')|int %}
          {% set i_map = {
            '1': 'Stuck Relay',
            '2': 'DC Overload',
            '3': 'AC Overload',
            '4': 'Dead Battery',
            '5': 'Backfeed',
            '8': 'Low Battery Cutout',
            '9': 'High Battery Cutout',
            '10': 'High AC Voltage Output',
            '16': 'Bad FET Bridge',
            '18': 'FET Overheat',
            '19': 'FET Overload',
            '22': 'Stack Mode Mismatch',
            '23': 'Stack Sync Clock Detection Fail',
            '24': 'Stack Clock Not In Phase',
            '25': 'Stack AC Voltage Output Not Phased',
            '32': 'Over Temp Shutdown',
            '33': 'Transfer Relay Open (Chg Mode)',
            '128': 'Bridge Fault (Chg Mode)',
            '129': 'High Battery Temp',
            '144': 'Transformer Temp Cutout',
            '145': 'CB3 30Amp Breaker Fail' } %}
          {% set a_map = {
            '9': 'AGS Test Start Fault',
            '10': 'AGS Temp Start Fault',
            '11': 'AGS Voltage Start Fault',
            '15': 'AGS Time Start Fault',
            '16': 'AGS SOC Start Fault',
            '17': 'AGS Exercise Start Fault',
            '21': 'AGS Amperage Start Fault',
            '22': 'AGS Topoff Fault',
            '24': 'AGS Max Run Fault',
            '25': 'AGS Generator Run Fault' } %}
          {{ i_map[i_fault] if i_fault in i_map else (a_map[a_fault] if a_fault in a_map else ('BMK Fault' if b_fault==2 else 'None')) }}      

################################################################
# Binary Sensors                                               #
################################################################        
binary_sensor:
  # AGS Gen Running
  - platform: mqtt
    name: magnum_ags_running # manual gen start
    state_topic: magnum/ags
    value_template: "{{ value_json.data.running | default(false, true) }}"
    payload_on: true
    payload_off: false
    json_attributes_topic: "magnum/ags"
    json_attributes_template: "{{ value_json.data.running | default(false, true) | tojson }}"
  # Inverter LED
  - platform: mqtt
    name: magnum_inverter_led # inverter
    state_topic: magnum/inverter
    payload_on: 1
    payload_off: 0
    value_template: "{{ value_json.data.invled | default(1, true) }}"
    json_attributes_topic: "magnum/inverter"
    json_attributes_template: "{{ value_json.data.invled | default(1, true) | tojson }}"
  # Charger LED
  - platform: mqtt
    name: magnum_charger_led # charger
    payload_on: 1
    payload_off: 0
    state_topic: magnum/inverter
    value_template: "{{ value_json.data.chgled | default(0, true) }}"
    json_attributes_topic: "magnum/inverter"
    json_attributes_template: "{{ value_json.data.chgled | default(0, true) | tojson }}"

################################################################
# Input Booleans                                               #
################################################################
input_boolean:
  # Aux AC Input
  magnum_aux_ac_input:
    name: Aux AC Input
    initial: false
  # In Float State
  magnum_in_float:
    name: In Float
    initial: false
  # In EQ State
  magnum_in_eq:
    name: In EQ
    initial: false

################################################################
# Switches                                                     #
################################################################
switch:
  # AGS Manual Run Switch
  - platform: mqtt
    name: magnum_ags_manual
    command_topic: "magnum/ags/manualRun/set"
    state_topic: "magnum/ags/manualRun"
    availability_topic: "magnum/ags/manualRun/available"
  # Inverter EQ Switch
  - platform: mqtt
    name: magnum_eq_toggle
    command_topic: "magnum/inverter/eq/toggle"
    state_topic: "magnum/inverter/eq/toggle"
    availability_topic: "magnum/inverter/eq/toggle/available"
  # Charger Switch
  - platform: mqtt
    name: magnum_charger_toggle
    command_topic: "magnum/inverter/chg/toggle"
    state_topic: "magnum/inverter/chg/toggle"
    availability_topic: "magnum/inverter/chg/toggle/available"
  # Inverter Switch
  - platform: mqtt
    name: magnum_inverter_toggle
    command_topic: "magnum/inverter/toggle"
    state_topic: "magnum/inverter"
    availability_topic: "magnum/inverter/toggle/available"
    value_template: "{{states('binary_sensor.magnum_invled')}}"
################################################################
# Timers                                                       #
################################################################
timer:
  # Charge State Timer
  magnum_charge_state_time:
    name: Charge State Time
################################################################
# Automations                                                  #
################################################################
automation:
  # Float Boolean Toggle
  - alias: Float on
    trigger:
      - platform: state
        entity_id: sensor.magnum_inverter_mode
        to: '2' # float
        for: "00:00:30"
      - platform: state
        entity_id: sensor.magnum_inverter_mode
        from: '2' # float
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.magnum_in_float
      - service: timer.start
        entity_id: timer.magnum_charge_state_time
  
# Inverter Boolean Toggle
  - alias: Inverter toggle
    trigger:
      - platform: state
        entity_id: binary_sensor.magnum_inverter_led
#        to: 'On'
    action:
      service: switch.toggle
      entity_id: switch.magnum_inverter_toggle
  
  # Charger Boolean Toggle 
  - alias: Charger toggle
    trigger:
      - platform: state
        entity_id: binary_sensor.magnum_charger_led
    action:
      - service: switch.toggle
        entity_id: switch.magnum_charger_toggle
      - service: timer.start
        entity_id: timer.magnum_charge_state_time

  # Equalize Boolean Toggle
  - alias: Equalize Toggle
    trigger:
      - platform: state
        entity_id: sensor.magnum_inverter_mode
        to: '1' # equalizing
        for: "00:00:30"
      - platform: state
        entity_id: sensor.magnum_inverter_mode
        from: '1' # equalizing
    action:
      - service: input_boolean.toggle
        entity_id: input_boolean.magnum_in_eq
      - service: timer.start
        entity_id: timer.magnum_charge_state_time

  # Aux AC Input
  - alias: Aux Gen Boolean Toggle
    trigger:
      - platform: numeric_state
        entity_id: sensor.magnum_inverter_aacin
        above: 0
        for:
          seconds: 30
      - platform: numeric_state
        entity_id: sensor.magnum_inverter_aacin
        below: 1
        for:
          second: 30
    action:
      - service: input_boolean.toggle
        entity_id: input_boolean.magnum_aux_ac_input

  # Default settings for switches
  - alias: Set default switch settings upon HA start
    trigger:
      - platform: homeassistant
        event: start
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.magnum_aux_ac_input
      - service: input_boolean.turn_off
        entity_id: input_boolean.magnum_in_eq
      - service: input_boolean.turn_off
        entity_id: input_boolean.magnum_in_float
      - service: switch.turn_off
        entity_id: switch.magnum_ags_manual
      - service: switch.turn_off
        entity_id: switch.magnum_chg_toggle
      - service: switch.turn_off
        entity_id: switch.magnum_eq_toggle
      - service: switch.turn_off
        entity_id: switch.magnum_inverter_toggle
